<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenma Video Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#ff3485',
                        accent: '#0ea5e9',
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                        },
                        light: {
                            100: '#f1f5f9',
                            200: '#ffffff',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-light-100 dark:bg-dark-900 text-primary dark:text-light-100 min-h-screen pb-8 overflow-x-hidden">
    <!-- Header -->
    <header class="sticky top-0 z-10 flex items-center px-4 py-3 gap-3 bg-light-200 dark:bg-dark-800 shadow-md w-full flex-wrap">
        <div class="logo w-6 h-7 bg-[url('logo.png')] bg-cover text-accent whitespace-nowrap">
        </div>
        <select id="sourcePicker" style="width:45%;" class="bg-light-200 dark:bg-dark-800 text-primary dark:text-light-100 border border-gray-300 dark:border-gray-600 rounded px-3 py-1.5 cursor-pointer text-base max-w-[70%] truncate"></select>
        <button id="btn-refresh" title="Yenile" class="bg-light-200 dark:bg-dark-800 text-primary dark:text-light-100 border border-gray-300 dark:border-gray-600 rounded p-2 cursor-pointer text-xl w-10 h-10 flex items-center justify-center transition hover:bg-accent/10 hover:scale-110">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button id="toggleSearch" title="Ara" class="bg-light-200 dark:bg-dark-800 text-primary dark:text-light-100 border border-gray-300 dark:border-gray-600 rounded p-2 cursor-pointer text-xl w-10 h-10 flex items-center justify-center transition hover:bg-accent/10 hover:scale-110">
            <i class="fas fa-search"></i>
        </button>
        <button id="btn-theme" title="Koyu Tema" class="bg-light-200 dark:bg-dark-800 text-primary dark:text-light-100 border border-gray-300 dark:border-gray-600 rounded p-2 cursor-pointer text-xl w-10 h-10 flex items-center justify-center transition hover:bg-accent/10 hover:scale-110">
            <i class="fas fa-moon"></i>
        </button>
    </header>

    <!-- Search Container -->
    <div id="searchContainer" class="fixed top-0 left-0 w-full bg-light-200 dark:bg-dark-800 p-4 shadow-lg transform -translate-y-full transition-transform z-20 flex gap-3">
        <input type="text" id="q" placeholder="Ara..." class="flex-1 px-4 py-2.5 border border-gray-300 dark:border-gray-600 rounded bg-light-100 dark:bg-dark-900 text-primary dark:text-light-100 text-base">
        <button id="btn-search" class="bg-light-200 dark:bg-dark-800 text-primary dark:text-light-100 border border-gray-300 dark:border-gray-600 rounded p-2 cursor-pointer text-xl w-10 h-10 flex items-center justify-center transition hover:bg-accent/10">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div id="listContainer" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-5 p-5 w-full box-border">
        <!-- Cards will be dynamically inserted here -->
    </div>

    <!-- Loading Indicator -->
    <div id="loadingMore" class="hidden text-center py-8">
        <div class="w-10 h-10 border-4 border-accent/30 border-t-accent rounded-full animate-spin mx-auto mb-3"></div>
        <div>
            Yükleniyor...
        </div>
    </div>

    <!-- Sentinel for infinite scroll -->
    <div id="sentinel"></div>

    <!-- Video Player Overlay -->
    <div id="playerOverlay" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center">
        <div class="relative w-full max-w-5xl">
            <video id="video" class="w-full rounded-lg" controls playsinline poster=""></video>
            <button id="closePlayer" class="absolute top-0 right-0 bg-none border-none text-primary text-3xl m-3 cursor-pointer">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        /* ======================== CONFIG & HELPERS ======================== */
        const SOURCES_URL = 'https://raw.githubusercontent.com/assian/TenMa_Sources/refs/heads/main/sources.json';
        const CORS_PROXY = 'https://api.codetabs.com/v1/proxy?quest=';
        const MAX_DETAIL_CONCURRENCY = 4;

        const el = id => document.getElementById(id);

        // Elementleri tanımla
        const listContainer = el('listContainer');
        const searchContainer = el('searchContainer');
        const toggleSearchBtn = el('toggleSearch');

        async function corsFetch(url, opts = {}) {
            try {
                const res = await fetch(CORS_PROXY + encodeURIComponent(url), opts);
                if (!res.ok) throw new Error('HTTP ' + res.status);
                return res;
            } catch(e) {
                const res2 = await fetch(url, opts);
                if (!res2.ok) throw new Error('HTTP ' + res2.status);
                return res2;
            }
        }

        /* ======================== SEARCH FUNCTIONALITY ======================== */
        function toggleSearch() {
            searchContainer.classList.toggle('translate-y-0');
            searchContainer.classList.toggle('-translate-y-full');
            if (searchContainer.classList.contains('translate-y-0')) {
                el('q').focus();
            }
        }

        function closeSearch() {
            searchContainer.classList.add('-translate-y-full');
            searchContainer.classList.remove('translate-y-0');
        }

        // Boşluğa tıklayınca arama kutusunu kapat
        document.addEventListener('click', (e) => {
            const isClickInsideSearch = searchContainer.contains(e.target);
            const isClickOnToggle = toggleSearchBtn.contains(e.target);

            if (searchContainer.classList.contains('translate-y-0') &&
                !isClickInsideSearch &&
                !isClickOnToggle) {
                closeSearch();
            }
        });

        // ESC tuşuyla arama kutusunu kapat
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeSearch();
            }
        });

        /* ======================== SOURCE MANAGEMENT ======================== */
        let APP_SOURCES = [];
        let currentSource = null;
        let currentPage = 1;
        let loading = false;
        let ended = false;
        let searchMode = false;
        let searchQuery = '';

        async function loadSources() {
            try {
                const r = await corsFetch(SOURCES_URL,
                    {
                        headers: {
                            Accept: 'application/json'
                        }
                    });
                const json = await r.json();
                if (!Array.isArray(json) || json.length === 0) throw new Error('Empty manifest');
                return json;
            } catch(e) {
                console.warn('Sources yüklenemedi', e);
                return [{
                    name: 'Örnek Kaynak',
                    baseUrl: 'https://example.com',
                    listUrl: 'https://example.com/list?page=${page}',
                    videoItemSelector: 'a',
                    titleSelector: 'a',
                    thumbnailSelector: 'img'
                }];
            }
        }

        function makeAbsolute(href, base) {
            if (!href) return null;
            href = href.trim();

            if (/^(https?:)?\/\//i.test(href)) {
                return href.replace(/(?<!:)\/+/g, '/');
            }

            const combined = (base || '').replace(/\/+$/, '') + '/' + href.replace(/^\/+/, '');
            return combined.replace(/(?<!:)\/+/g, '/');
        }

        function renderSourcePicker(sources) {
            const sel = el('sourcePicker');
            sel.innerHTML = '';
            sources.forEach((s, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = s.name || ('source-' + i);
                sel.appendChild(opt);
            });
        }

        /* ======================== CONTENT FETCHING ======================== */
        function parseItemsFromHtml(htmlText, src) {
            const doc = new DOMParser().parseFromString(htmlText, 'text/html');
            const selector = src.videoItemSelector || 'a';
            const nodes = Array.from(doc.querySelectorAll(selector));
            return nodes.map(node => {
                const link = src.detailPageLinkSelector ?
                node.querySelector(src.detailPageLinkSelector):
                node.querySelector('a') || node;

                const href = link?.getAttribute('href') || link?.dataset?.href || 'no-id';
                const titleNode = node.querySelector(src.titleSelector) ||
                node.querySelector('h3') ||
                node.querySelector('a') ||
                node;

                const thumbNode = node.querySelector(src.thumbnailSelector) ||
                node.querySelector('img');

                const thumb = thumbNode ?
                (thumbNode.dataset?.original || thumbNode.getAttribute('src')):
                null;

                return {
                    id: href,
                    title: (titleNode?.title) || (titleNode?.textContent || '').trim() || href,
                    thumbnail: thumb || null,
                    url: makeAbsolute(href, src.baseUrl || ''),
                    baseUrl: src.baseUrl || ''
                };
            }).filter(Boolean);
        }

        async function apiGetList(src, page = 1) {
            if (!src) throw new Error('Source missing');
            const url = (src.listUrl || '').replace('${page}', page);
            const res = await corsFetch(url, {
                headers: {
                    'User-Agent': src.userAgent || 'Mozilla/5.0'
                }
            });
            const html = await res.text();
            const items = parseItemsFromHtml(html, src);
            return {
                source: src.name || null,
                page,
                items
            };
        }

        async function apiSearch(src, query = '', page = 1) {
            if (!src) throw new Error('Source missing');
            if (!src.searchUrl) throw new Error('Search not supported by this source');

            const encQuery = encodeURIComponent(String(query || ''));
            const pageStr = String(page);

            let url = src.searchUrl
            .replace(/\$\{query\}/g, encQuery)
            .replace(/\{query\}/g, encQuery)
            .replace(/\%s/g, encQuery)
            .replace(/\$\{page\}/g, pageStr)
            .replace(/\{page\}/g, pageStr);

            if (!/\$\{query\}|\{query\}|\%s/.test(src.searchUrl)) {
                url += (url.includes('?') ? '&': '?') + 'q=' + encQuery;
            }

            if (!/\$\{page\}|\{page\}/.test(src.searchUrl) && page > 1) {
                url += (url.includes('?') ? '&': '?') + 'page=' + pageStr;
            }

            const res = await corsFetch(url, {
                headers: {
                    'User-Agent': src.userAgent || 'Mozilla/5.0'
                }
            });
            const html = await res.text();
            const items = parseItemsFromHtml(html, src);
            return {
                source: src.name || null,
                page,
                query,
                items,
                rawUrl: url
            };
        }

        /* ======================== DETAIL FETCHING ======================== */
        const detailQueue = [];
        let detailActive = 0;

        function enqueueDetailFetch(task) {
            return new Promise((resolve, reject) => {
                detailQueue.push({
                    task, resolve, reject
                });
                processDetailQueue();
            });
        }

        function processDetailQueue() {
            if (detailActive >= MAX_DETAIL_CONCURRENCY) return;
            const item = detailQueue.shift();
            if (!item) return;
            detailActive++;
            item.task().then(res => {
                detailActive--;
                item.resolve(res);
                processDetailQueue();
            }).catch(err => {
                detailActive--;
                item.reject(err);
                processDetailQueue();
            });
        }

        function normalizeVideoUrl(url, baseUrl) {
            if (!url) return null;
            let u = url.trim();
            u = u.replace(/\\+/g, '/').replace(/\/+/g, '/');
            u = u.replace(/^https?:\//i, match => match.endsWith('//') ? match : match + '/');

                if (/^https?:\/\//i.test(u)) return u;
                if (/^\/\//.test(u)) return 'https:' + u;
                if (baseUrl) {
                    let base = baseUrl.endsWith('/') ? baseUrl.slice(0, -1): baseUrl;
                    let path = u.startsWith('/') ? u: '/' + u;
                    return base + path;
                }
                return u;
            }

            async function extractVideoUrlFromPage(html, src, baseUrl) {
                const regexKey = src.videoUrlRegex || src.videoPlayerRegex || src.videoRegex;
                if (regexKey) {
                    try {
                        const regex = new RegExp(regexKey, 'i');
                        const matches = html.match(regex);
                        if (matches && matches[1]) {
                            return normalizeVideoUrl(matches[1], baseUrl);
                        }
                    } catch(e) {
                        console.error('Regex error', e);
                    }
                }

                const doc = new DOMParser().parseFromString(html, 'text/html');

                // Check iframes
                const iframes = Array.from(doc.querySelectorAll('iframe'));
                for (const iframe of iframes) {
                    const src = iframe.getAttribute('src');
                    if (src && (src.includes('youtube.com') || src.includes('vimeo.com') || src.includes('dailymotion.com'))) {
                        return makeAbsolute(src, baseUrl);
                    }
                }

                // Check video tags
                const videoTags = Array.from(doc.querySelectorAll('video'));
                for (const video of videoTags) {
                    const src = video.getAttribute('src');
                    if (src) return makeAbsolute(src, baseUrl);

                    const sourceTags = Array.from(video.querySelectorAll('source'));
                    for (const source of sourceTags) {
                        const src = source.getAttribute('src');
                        if (src) return makeAbsolute(src, baseUrl);
                    }
                }

                // Check JavaScript variables
                const scripts = Array.from(doc.querySelectorAll('script')).map(s => s.textContent).join('\n');
                const urlPatterns = [
                    /(https?:\/\/[^\s'"]+\.(mp4|m3u8|webm|mov)[^\s'"]*)/gi,
                    /file:\s*["'](https?:\/\/[^"']+)["']/gi,
                    /source:\s*["'](https?:\/\/[^"']+)["']/gi,
                    /src:\s*["'](https?:\/\/[^"']+)["']/gi
                ];

                for (const pattern of urlPatterns) {
                    const matches = scripts.match(pattern);
                    if (matches) {
                        for (const match of matches) {
                            const url = match.replace(/^['"]|['"]$/g, '');
                            if (url.includes('.mp4') || url.includes('.m3u8') || url.includes('.webm') || url.includes('.mov')) {
                                return makeAbsolute(url, baseUrl);
                            }
                        }
                    }
                }

                // Check data attributes
                const elementsWithData = Array.from(doc.querySelectorAll('[data-src],[data-video-src],[data-file]'));
                for (const element of elementsWithData) {
                    const src = element.getAttribute('data-src') ||
                    element.getAttribute('data-video-src') ||
                    element.getAttribute('data-file');
                    if (src && (src.includes('.mp4') || src.includes('.m3u8'))) {
                        return makeAbsolute(src, baseUrl);
                    }
                }

                // Check JW Player
                const jwPlayerMatches = scripts.match(/file\s*:\s*["'](https?:\/\/[^"']+)["']/i);
                if (jwPlayerMatches && jwPlayerMatches[1]) {
                    return makeAbsolute(jwPlayerMatches[1], baseUrl);
                }

                return null;
            }

            async function fetchDetailForItem(src, item) {
                if (item._fetched) return item;
                return enqueueDetailFetch(async () => {
                    try {
                        const res = await corsFetch(item.url, {
                            headers: {
                                'User-Agent': src.userAgent || 'Mozilla/5.0'
                            }
                        });
                        const html = await res.text();

                        item.realUrl = await extractVideoUrlFromPage(html, src, item.baseUrl);

                        if (!item.thumbnail) {
                            const doc = new DOMParser().parseFromString(html, 'text/html');
                            const ogImage = doc.querySelector('meta[property="og:image"]')?.getAttribute('content') ||
                            doc.querySelector('meta[name="twitter:image"]')?.getAttribute('content');
                            if (ogImage) {
                                item.thumbnail = makeAbsolute(ogImage, item.baseUrl);
                            }
                        }

                        item._fetched = true;
                        return item;
                    } catch(e) {
                        console.error('Error fetching details:', e);
                        item._fetched = true;
                        return item;
                    }
                });
            }

            /* ======================== UI RENDERING ======================== */
            const observerLazy = new IntersectionObserver((entries) => {
                entries.forEach(ent => {
                    if (ent.isIntersecting) {
                        const img = ent.target;
                        if (img.dataset.src) {
                            img.src = img.dataset.src;
                            img.removeAttribute('data-src');
                        }
                        observerLazy.unobserve(img);
                    }
                });
            }, {
                rootMargin: '200px'
            });

            const observerVisible = new IntersectionObserver((entries) => {
                entries.forEach(ent => {
                    if (ent.isIntersecting) {
                        const card = ent.target;
                        const idx = card.__itemIndex;
                        if (idx != null) {
                            const wrapper = card.__wrapper;
                            fetchDetailForItem(wrapper.src, wrapper.item).then(updated => {
                                if (updated.thumbnail) {
                                    const img = card.querySelector('img');
                                    if (img && !img.src) img.src = updated.thumbnail;
                                }
                            });
                        }
                        observerVisible.unobserve(card);
                    }
                });
            }, {
                rootMargin: '300px'
            });

            function createCard(src, item) {
                const card = document.createElement('div');
                card.className = 'bg-light-200 dark:bg-dark-800 rounded-lg overflow-hidden shadow-md transition-transform hover:-translate-y-1 hover:shadow-xl cursor-pointer max-w-full';

                <!-- Inside createCard function (script section) - Replace the thumb element creation -->
                const thumb = document.createElement('div');
                thumb.className = 'relative w-full pb-[56.25%] bg-gray-200 dark:bg-gray-700 overflow-hidden';

                // Skeleton loader
                const skeleton = document.createElement('div');
                skeleton.className = 'skeleton absolute inset-0 bg-gray-300 dark:bg-gray-600 animate-pulse z-10';
                thumb.appendChild(skeleton);

                // Spinner container
                const spinnerContainer = document.createElement('div');
                spinnerContainer.className = 'spinner-container absolute inset-0 flex items-center justify-center z-20';
                spinnerContainer.innerHTML = `
                <div class="w-8 h-8 border-4 border-accent/30 border-t-accent rounded-full animate-spin"></div>
                `;
                thumb.appendChild(spinnerContainer);

                // Image with blur effect
                const img = document.createElement('img');
                img.className = 'absolute top-0 left-0 w-full h-full object-cover transition-all duration-500 opacity-0 blur-md';
                img.alt = item.title || 'thumb';
                img.dataset.src = item.thumbnail || '';

                img.onload = function() {
                    this.classList.remove('opacity-0', 'blur-md');
                    this.classList.add('opacity-100', 'blur-none');
                    skeleton.remove();
                    spinnerContainer.remove();
                };

                img.onerror = function() {
                    this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="180"><rect width="100%" height="100%" fill="%23f1f5f9"/><text x="50%" y="50%" fill="%23334155" font-size="18" text-anchor="middle" dy="6">No Thumb</text></svg>';
                    skeleton.remove();
                    spinnerContainer.remove();
                    this.classList.remove('opacity-0', 'blur-md');
                    this.classList.add('opacity-100');
                };

                thumb.appendChild(img);

                // Play overlay remains the same...        const img = document.createElement('img');
                img.className = 'absolute top-0 left-0 w-full h-full object-cover transition-transform group-hover:scale-105';
                img.alt = item.title || 'thumb';
                img.src = '';
                img.dataset.src = item.thumbnail || '';
                img.onerror = () => {
                    img.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="320" height="180"><rect width="100%" height="100%" fill="%23f1f5f9"/><text x="50%" y="50%" fill="%23334155" font-size="18" text-anchor="middle" dy="6">No Thumb</text></svg>';
                };
                thumb.appendChild(img);

                // SVG play overlay
                const overlay = document.createElement('div');
                overlay.className = 'absolute inset-0 flex items-center justify-center pointer-events-none text-primary opacity-50 text-6xl transition-opacity group-hover:opacity-100';
                overlay.innerHTML = `<i class="fas fa-play"></i>`;
                thumb.appendChild(overlay);

                const info = document.createElement('div');
                info.className = 'p-3 overflow-hidden';
                const t = document.createElement('h3');
                t.className = 'font-medium text-base mb-1 line-clamp-2';
                t.textContent = item.title || 'Untitled';
                info.appendChild(t);

                const source = document.createElement('div');
                source.className = 'text-accent text-sm truncate';
                source.textContent = src.name || 'Unknown source';
                info.appendChild(source);

                card.appendChild(thumb);
                card.appendChild(info);

                card.addEventListener('click', async () => {
                    await fetchDetailForItem(src, item);
                    openVideo(item);
                });

                observerLazy.observe(img);
                observerVisible.observe(card);

                return {
                    el: card, img, item
                };
            }

            function renderItemsAppend(src, items) {
                const frag = document.createDocumentFragment();
                items.forEach((it, i) => {
                    const node = createCard(src, it);
                    node.el.__itemIndex = listContainer.children.length + i;
                    node.el.__wrapper = {
                        src, item: it
                    };
                    frag.appendChild(node.el);
                });
                listContainer.appendChild(frag);
            }

            /* ======================== PLAYER MANAGEMENT ======================== */
            let currentHls = null;

            async function openVideo(item) {
                await fetchDetailForItem(currentSource, item);

                const overlay = el('playerOverlay');
                const video = el('video');

                // Poster ayarla
                if (item.thumbnail) {
                    video.poster = item.thumbnail;
                }

                // Video URL'sini ayarla
                const url = item.realUrl || item.url;

                try {
                    // Eski kaynağı temizle
                    video.pause();
                    video.removeAttribute('src');
                    video.load();

                    // Yeni kaynağı yükle
                    if (url && url.match(/\.m3u8($|\?|#)/i) && Hls.isSupported()) {
                        if (currentHls) {
                            currentHls.destroy();
                        }
                        currentHls = new Hls();
                        currentHls.loadSource(url);
                        currentHls.attachMedia(video);
                        currentHls.on(Hls.Events.MANIFEST_PARSED, () => {
                            video.play().catch(e => console.log('Auto-play prevented', e));
                        });
                    } else {
                        video.src = url;
                        video.load();
                        video.play().catch(e => console.log('Auto-play prevented', e));
                    }

                    overlay.style.display = 'flex';
                    document.body.style.overflow = 'hidden';
                } catch(e) {
                    console.error('Player error', e);
                    alert('Video oynatma hatası: ' + e.message);
                }
            }

            el('closePlayer').addEventListener('click', () => {
                const overlay = el('playerOverlay');
                overlay.style.display = 'none';
                const v = el('video');
                v.pause();
                try {
                    v.removeAttribute('src');
                    v.load();
                    if (currentHls) {
                        currentHls.destroy();
                        currentHls = null;
                    }
                } catch(e) {}
                document.body.style.overflow = 'auto';
            });

            /* ======================== APP FLOW ======================== */
            const sentinel = el('sentinel');
            const io = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting && !loading && !ended) {
                        loadNextPage();
                    }
                });
            }, {
                rootMargin: '600px'
            });
            io.observe(sentinel);

            async function loadNextPage() {
                if (!currentSource) return;
                loading = true;
                el('loadingMore').classList.remove('hidden');

                try {
                    let res;
                    if (searchMode && searchQuery) {
                        res = await apiSearch(currentSource, searchQuery, currentPage);
                    } else {
                        res = await apiGetList(currentSource, currentPage);
                    }

                    const items = res.items || [];
                    if (items.length === 0) {
                        ended = true;
                    }
                    renderItemsAppend(currentSource, items);
                    currentPage++;
                } catch(e) {
                    console.error('Sayfa yükleme hatası', e);
                }

                loading = false;
                el('loadingMore').classList.add('hidden');
            }

            async function resetAndLoad(srcIdx, query = '') {
                listContainer.innerHTML = '';
                currentPage = 1;
                ended = false;
                searchMode = false;
                searchQuery = '';
                currentSource = APP_SOURCES[srcIdx];
                await loadNextPage();
            }

            async function performSearch(query) {
                query = String(query || '').trim();
                if (!query) {
                    const idx = parseInt(el('sourcePicker').value || 0, 10);
                    await resetAndLoad(idx);
                    return;
                }

                listContainer.innerHTML = '';
                currentPage = 1;
                ended = false;
                searchMode = true;
                searchQuery = query;

                const idx = parseInt(el('sourcePicker').value || 0, 10);
                currentSource = APP_SOURCES[idx];

                await loadNextPage();
                closeSearch();
            }

            /* ======================== INITIALIZATION ======================== */
            async function main() {
                // Tema butonu başlangıç ayarı
                const themeBtn = el('btn-theme');

                // Tema değiştirme olay dinleyicisi
                themeBtn.addEventListener('click', () => {
                    const curTheme = document.documentElement.classList.contains('dark') ? 'dark': 'light';
                    const newTheme = curTheme === 'light' ? 'dark': 'light';

                    if (newTheme === 'dark') {
                        document.documentElement.classList.add('dark');
                        themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                        themeBtn.title = 'Açık Tema';
                    } else {
                        document.documentElement.classList.remove('dark');
                        themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                        themeBtn.title = 'Koyu Tema';
                    }

                    // Tema tercihini localStorage'a kaydet
                    localStorage.setItem('theme', newTheme);
                });

                // Kayıtlı tema tercihini yükle
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                    themeBtn.title = 'Açık Tema';
                } else {
                    document.documentElement.classList.remove('dark');
                    themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                    themeBtn.title = 'Koyu Tema';
                }

                // Search events
                el('toggleSearch').addEventListener('click', toggleSearch);
                el('btn-search').addEventListener('click', () => {
                    performSearch(el('q').value.trim());
                });

                el('q').addEventListener('keydown', async (e) => {
                    if (e.key === 'Enter') {
                        performSearch(el('q').value.trim());
                    }
                });

                // Refresh button
                el('btn-refresh').addEventListener('click',
                    async () => {
                        listContainer.innerHTML = '';
                        currentPage = 1;
                        ended = false;
                        await loadNextPage();
                    });

                // Source picker
                el('sourcePicker').addEventListener('change',
                    () => {
                        resetAndLoad(parseInt(el('sourcePicker').value || 0, 10));
                    });

                // Load sources and start
                APP_SOURCES = await loadSources();
                renderSourcePicker(APP_SOURCES);
                await resetAndLoad(0);
            }

            // Start the application
            main().catch(e => {
                console.error(e);
                listContainer.innerHTML = '<div class="text-center py-10 text-red-500">Hata: ' + (e.message || e) + '</div>';
            });
        </script>
    </body>
</html>